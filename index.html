<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.0.2/tailwind.min.css">
    <title>headless-whatsapp</title>
    <style scoped>
        .full-screen-bg {
            height: 130vh;
            /* 100% of the viewport height */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        /* .alert-success {
            color: #155724;
            background-color: #d4edda;
            border-color: #c3e6cb;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: none;
        } */
    </style>
</head>
<body>
    <section class="text-gray-400 bg-gray-900 body-font full-screen-bg">
        <div class="container mx-auto flex px-5 py-24 items-center justify-center flex-col">
            <h1 class="title-font sm:text-4xl text-3xl mb-4 font-medium text-white">Welcome to headless-whatsapp </h1>
            <div id="qrcode-container"></div>
            <img id="qrImage" class="lg:w-2/6 md:w-3/6 w-5/6 mb-10 object-cover object-center rounded" alt="hero" style="display: none;">
            <div class="text-center lg:w-2/3 w-full">
                <!-- <h1 class="title-font sm:text-4xl text-3xl mb-4 font-medium text-white">Microdosing synth tattooed vexillologist</h1>
                <p class="leading-relaxed mb-8">Meggings kinfolk echo park stumptown DIY, kale chips beard jianbing tousled. Chambray dreamcatcher trust fund, kitsch vice godard disrupt ramps hexagon mustache umami snackwave tilde chillwave ugh. Pour-over meditation PBR&amp;B pickled ennui celiac mlkshk freegan photo booth af fingerstache pitchfork.</p> -->
                <div class="flex justify-center">
                    <button class="inline-flex text-white bg-indigo-500 border-0 py-2 px-6 focus:outline-none hover:bg-indigo-600 rounded text-lg" onclick="loginQR()" id="login-btn">Login</button>
                    <!-- <button class="ml-4 inline-flex text-gray-400 bg-gray-800 border-0 py-2 px-6 focus:outline-none hover:bg-gray-700 hover:text-white rounded text-lg">Button</button> -->
                </div>
            </div>
            <div id="send-msg" class="flex w-full md:justify-start justify-center items-end">
                <div class="relative mr-4 md:w-full lg:w-full xl:w-1/2 w-2/4">
                    <form>
                        <label for="hero-field" class="leading-7 text-sm text-gray-400">To</label>
                        <input type="text" id="receiver" name="hero-field" class="w-full bg-gray-800 rounded bg-opacity-40 border border-gray-700 focus:ring-2 focus:ring-indigo-900 focus:bg-transparent focus:border-indigo-500 text-base outline-none text-gray-100 py-1 px-3 leading-8 transition-colors duration-200 ease-in-out">
                        <label for="hero-field2" class="leading-7 text-sm text-gray-400">Message</label>
                        <textarea id="msg" name="hero-field2" class="w-full bg-gray-800 rounded bg-opacity-40 border border-gray-700 focus:ring-2 focus:ring-indigo-900 focus:bg-transparent focus:border-indigo-500 text-base outline-none text-gray-100 py-1 px-3 leading-8 transition-colors duration-200 ease-in-out"></textarea>
                        <!-- <input type="text" id="msg" name="hero-field2" class="w-full bg-gray-800 rounded bg-opacity-40 border border-gray-700 focus:ring-2 focus:ring-indigo-900 focus:bg-transparent focus:border-indigo-500 text-base outline-none text-gray-100 py-1 px-3 leading-8 transition-colors duration-200 ease-in-out"> -->
                        <button id="send" type="submit" class="inline-flex text-white bg-indigo-500 border-0 py-2 px-6 focus:outline-none hover:bg-indigo-600 rounded text-lg" onclick="sendMessage()">Send Message</button>
                    </form>  
                    <br><br><p>OR</p><br> 
                    <form>
                        <label for="msg-template" class="leading-7 text-sm text-gray-400">Message Template</label>
                        <textarea id="msg-template" name="msg-template" class="w-full bg-gray-800 rounded bg-opacity-40 border border-gray-700 focus:ring-2 focus:ring-indigo-900 focus:bg-transparent focus:border-indigo-500 text-base outline-none text-gray-100 py-1 px-3 leading-8 transition-colors duration-200 ease-in-out"></textarea>
                        <br>
                        <label for="csvUpload" class="leading-7 text-sm text-gray-400">Upload Phone Numbers CSV</label>
                        <input type="file" id="csvUpload" name="csvUpload" accept=".csv" class="w-full bg-gray-800 rounded bg-opacity-40 border border-gray-700 focus:ring-2 focus:ring-indigo-900 focus:bg-transparent focus:border-indigo-500 text-base outline-none text-gray-100 py-1 px-3 leading-8 transition-colors duration-200 ease-in-out">
                        <!-- <p>The CSV should look like phone_number, message_variable1(if any), message_variable2(if any),etc</p> -->

                        <!-- <button id="upload" type="submit" class="inline-flex text-white bg-indigo-500 border-0 py-2 px-6 focus:outline-none hover:bg-indigo-600 rounded text-lg" onclick="uploadCSV()">Upload</button> -->
                        <!-- <br><br>
                        <label for="msgcsvUpload" class="leading-7 text-sm text-gray-400">Upload Message variables CSV</label>
                        <input type="file" id="msgcsvUpload" name="msgcsvUpload" accept=".csv" class="w-full bg-gray-800 rounded bg-opacity-40 border border-gray-700 focus:ring-2 focus:ring-indigo-900 focus:bg-transparent focus:border-indigo-500 text-base outline-none text-gray-100 py-1 px-3 leading-8 transition-colors duration-200 ease-in-out"> -->
                        <!-- <br>
                        <label for="msg-template" class="leading-7 text-sm text-gray-400">Message Template</label>
                        <textarea id="msg-template" name="msg-template" class="w-full bg-gray-800 rounded bg-opacity-40 border border-gray-700 focus:ring-2 focus:ring-indigo-900 focus:bg-transparent focus:border-indigo-500 text-base outline-none text-gray-100 py-1 px-3 leading-8 transition-colors duration-200 ease-in-out"></textarea> -->
                        <br><br>
                        <button id="upload" type="submit" class="inline-flex text-white bg-indigo-500 border-0 py-2 px-6 focus:outline-none hover:bg-indigo-600 rounded text-lg">Upload</button>
                        <br><br>
                        <!-- <p>The CSV should look like phone_number, message_variable1(if any), message_variable2(if any),etc</p> -->

                    </form>
                    <!-- <blockquote class="text-lg text-white dark:text-white">
                        <p>PS : </p>
                        <p>csv format -  phone_number, message_variable1 [if any], message_variable2 [if any],etc</p>
                    </blockquote> -->

                </div>
            </div>
        </div>
    </section>
    <!-- <div id="success-alert" class="alert alert-success">Message sent successfully!</div> -->
    <!-- <button onclick="getQRCode()">Login</button> -->
        <!-- Success Alert -->
    <div class="bg-green-500 text-white px-6 py-4 border-l-4 border-green-700 rounded shadow-lg fixed top-8 right-8" id="successAlert" style="display: none;">
        <div class="flex items-center">
            <!-- <div class="w-4 h-4 bg-white mr-2">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path d="M10 2C5.263 2 2 5.262 2 10s3.263 8 8 8 8-3.262 8-8-3.263-8-8-8zm0 14c-2.205 0-4-1.795-4-4s1.795-4 4-4 4 1.795 4 4-1.795 4-4 4zm-.707-7.293c-.195.195-.293.451-.293.707s.098.512.293.707c.195.195.451.293.707.293s.512-.098.707-.293c.391-.391.391-1.023 0-1.414-.39-.39-1.023-.39-1.414 0z" />
                </svg>
            </div> -->
            <div id="alert-content">âœ… Message sent!
            </div>
        </div>
        <!-- <button class="ml-auto focus:outline-none" id="closeButton">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6">
            <path fill-rule="evenodd" d="M13.293 10l3.646-3.646a1 1 0 0 0-1.414-1.414L10 8.586 6.354 4.94a1 1 0 1 0-1.414 1.414L8.586 10l-3.646 3.646a1 1 0 0 0 1.414 1.414L10 11.414l3.646 3.646a1 1 0 0 0 1.414-1.414L11.414 10z" clip-rule="evenodd" />
            </svg>
        </button> -->
    </div>
    <div class="bg-red-500 text-white px-6 py-4 border-l-4 border-red-700 rounded shadow-lg fixed top-8 right-8" id="failAlert" style="display: none;">
        <div class="flex items-center">
            <!-- <div class="w-4 h-4 bg-white mr-2">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                <path d="M10 2C5.263 2 2 5.262 2 10s3.263 8 8 8 8-3.262 8-8-3.263-8-8-8zm0 14c-2.205 0-4-1.795-4-4s1.795-4 4-4 4 1.795 4 4-1.795 4-4 4zm-.707-7.293c-.195.195-.293.451-.293.707s.098.512.293.707c.195.195.451.293.707.293s.512-.098.707-.293c.391-.391.391-1.023 0-1.414-.39-.39-1.023-.39-1.414 0z" />
                </svg>
            </div> -->
            <div id="fail-alert-content">
            </div>
        </div>
        <!-- <button class="ml-auto focus:outline-none" id="closeButton">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6">
            <path fill-rule="evenodd" d="M13.293 10l3.646-3.646a1 1 0 0 0-1.414-1.414L10 8.586 6.354 4.94a1 1 0 1 0-1.414 1.414L8.586 10l-3.646 3.646a1 1 0 0 0 1.414 1.414L10 11.414l3.646 3.646a1 1 0 0 0 1.414-1.414L11.414 10z" clip-rule="evenodd" />
            </svg>
        </button> -->
    </div>
    <script>
        // async function getQRCode(){
        //     try {
        //         const init = await fetch('http://localhost:3000/init')
        //         const response = await fetch('http://localhost:3000/qr');
        //         const qrData = await response.text();
        //         const qrCodeContainer = document.getElementById('qrcode-container');

        //         const qrCodeImage = document.createElement('img');
        //         qrCodeImage.id = "qrImage"
        //         qrCodeImage.src = qrData;
        //         qrCodeImage.classList = "g:w-2/6 md:w-3/6 w-5/6 mb-10 object-cover object-center rounded"
        //         qrCodeContainer.appendChild(qrCodeImage)
                
        //         const btn = document.getElementById('login-btn');
        //         btn.style.display = 'none';
                
        //     } catch (error) {
        //         console.error('Error fetching QR')
        //     }
        // }
        async function loginQR(){
            try {
                // const btn = document.getElementById("login-btn");
                // btn.style.display = 'none'
                await fetch('http://localhost:3000/login')

            } catch (error) {
                console.log(error)
            }
        }
        async function sendMessage(){
            const data = {
                customerMobile: document.getElementById("receiver").value,
                customMessage: document.getElementById("msg").value
            }
            document.getElementById('alert-content').innerText = 'Sending Message...'
            document.getElementById('successAlert').style.display = 'block';
            setTimeout(() => {
                document.getElementById('successAlert').style.display = 'none';
            }, 3000);
            var send_btn = document.getElementById("send");
            send_btn.style.display = 'none'
            try{
                fetch('http://localhost:3000/message', {
                    method: 'POST', 
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                }).then(response => {
                    document.getElementById('alert-content').innerText = 'Message Sent!'
                    document.getElementById('successAlert').style.display = 'block';
                    setTimeout(() => {
                        document.getElementById('successAlert').style.display = 'none';
                        send_btn.style.display = 'block'
                    }, 3000);
                    return response.json();
                })
                .then(response_data => console.log(response_data))
                .catch((error) => console.error('Error', error));
            } catch(error){
                console.log(error)
            }
        }

        const CSVToArray = (data, delimiter = ',', omitFirstRow = false) => data
        .slice(omitFirstRow ? data.indexOf('\n') + 1 : 0)
        .split('\n')
        .map(v => v.split(delimiter));

        async function uploadCSV(event) {
            event.preventDefault(); // Prevent the page from refreshing
            // Read the CSV file
            const fileInput = document.getElementById('csvUpload');
            const file = fileInput.files[0];

            if (!file) {
                // Handle the case where no file is selected
                console.log("No file selected");
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                const csv = e.target.result;
                const array = CSVToArray(csv);
//                 let new_arr = Array.from(new Set(array), x => x)
//                 console.log(typeof(new_arr))
//                 console.log(new_arr)
// //                console.log(length(new_arr))
                console.log(typeof(array[0][0]))
                // console.log(typeof(new_arr))
                //console.log(array[0])
                let upload_btn = document.getElementById("upload")              
                if(array[0][0] === 'phone_number'){
                    const data = {
                        users: array,
                        message_template: document.getElementById("msg-template").value
                    }
                    console.log(data)  
                    try {
                        document.getElementById('alert-content').innerText = 'Message Sending Sequence Started!'
                        document.getElementById('successAlert').style.display = 'block';
                        setTimeout(() => {
                            document.getElementById('successAlert').style.display = 'none';
                            upload_btn.style.display = 'none'
                        }, 3000);

                        fetch('http://localhost:3000/bulk-messages', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(data)
                        }).then(response => {
                            document.getElementById('alert-content').innerText = 'All Messages Sent!'
                            document.getElementById('successAlert').style.display = 'block';
                            setTimeout(() => {
                                document.getElementById('successAlert').style.display = 'none';
                                upload_btn.style.display = 'block'
                            }, 3000);
                            return response.json(); 
                        })
                        .then(response_data => console.log(response_data))
                        .catch((error) => console.error('Error', error));

                    } catch (error) {
                        console.log(error)
                    }
                } else{
                    document.getElementById('fail-alert-content').innerText = 'The csv data is not in the mentioned format :('
                    document.getElementById('failAlert').style.display = 'block';
                    setTimeout(() => {
                        document.getElementById('failAlert').style.display = 'none';
                        upload_btn.style.display = 'block'
                    }, 3000);
                    
                }
                
                

                // Pass the array to the backend
                // Example: send array to the backend using Axios
                // axios.post('/upload', { data: array })
                // .then((response) => {
                //     console.log(response);
                // })
                // .catch((error) => {
                //     console.error(error);
                // });
            };

            reader.readAsText(file);
        }
        // Add an event listener to the submit button
        const submitButton = document.getElementById('upload');
        submitButton.addEventListener('click', uploadCSV);
    </script>
    <script>
        const socket = new WebSocket('ws://localhost:8080');
        console.log(socket)
        socket.addEventListener("open", (data) => {
            console.log("event " , data)
        })
        socket.addEventListener('message', function (event) {
            let data = event.data;
            let log_status = event.status;
            try {
                data = JSON.parse(event.data);
                console.log("Data Parsed!")
                
            } catch (error) {
                console.error(event.data);
                return;
            }
            console.log(data)
            if (data.status === 'logged in') {
                // Update the UI to show that the user is logged in
                console.log('User is logged in');
                const btn = document.getElementById('login-btn');
                btn.style.display = 'none';
                const qr_box = document.getElementById('qrImage');
                qr_box.style.display = 'none'

            } else {
                // Update the QR code in the UI
                if(data.isqr){
                    let qrImage = document.getElementById('qrImage');
                    qrImage.src = data.qr;
                }
                // const msg_div = document.getElementById("send-msg");
                // msg_div.style.display = 'none'
                
            }
        });
    </script>
</body>

</html>